package com.cdiscount.fileparser;

import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.StringTokenizer;

public class ComputeToxicity {
	private static String insert_rate_string ="INSERT INTO TRUST_RATING(SOURCE_URL, SOURCE_DOMAIN, NB_LINKS, LINK_TRUSTFLOW, COMPUTED_TRUST_RATE_LINK, COMPUTED_TRUST_RATE_DOMAIN) VALUES (?,?,?,?,?,?)";
	private static int batch_size = 50000;
	private static Map<String, Integer> counting_map = new HashMap<String, Integer>();
	private static int links_to_access = 1000;
	public static void main(String[] args) throws IOException {
		String csvFile = "/home/sduprey/My_Data/My_Toxic_Links/cdiscount.csv";
		BufferedReader br = null;
		String line = "";
		String header = null;
		String[] column_names = null;
		String cvsSplitBy = ",";
		int nb_line=1;
		// we loop over the file a first time
		try {
			// we loop over the file a first time
			br = new BufferedReader(
					new InputStreamReader(
							new FileInputStream(csvFile), "UTF8"));
			// we skip the first line : the headers
			header = br.readLine();
			column_names= header.split(cvsSplitBy);
			System.out.println(column_names);
			while ((line = br.readLine()) != null) {
				String[] splitted_line = line.split(cvsSplitBy);
				System.out.println("Reading line number :"+nb_line);
				try {
					String targetURL = splitted_line[0];
					String sourceURL = splitted_line[1];
					populateLinksMap(targetURL,sourceURL);
				} catch (Exception exx) {
					exx.printStackTrace();
				}
				nb_line++;
			}
			displayFoundLinks();
		} catch (Exception ex) {
			ex.printStackTrace();
		}finally{

			if (br != null) {
				try {
					br.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}
		// we loop over the file a second time to make the computation
	
		Connection con = null;
		PreparedStatement pst = null;
		// the csv file variables
		String url ="jdbc:postgresql://localhost/LINKSDB";
		String user ="postgres";
		String passwd ="mogette";
		nb_line=1;
		int nb_batch=1;
		// last error
		try {
			con = DriverManager.getConnection(url, user, passwd);
			con.setAutoCommit(false);
			pst = con.prepareStatement(insert_rate_string);
	
			// we loop over the file a second time to make the computation
			br = new BufferedReader(
					new InputStreamReader(
							new FileInputStream(csvFile), "UTF8"));
			// we skip the first line : the headers
			header = br.readLine();
			column_names= header.split(cvsSplitBy);
			System.out.println(column_names);
			while ((line = br.readLine()) != null && nb_line<=links_to_access) {
				String[] splitted_line = line.split(cvsSplitBy);
				System.out.println("Inserting line number :"+nb_line);
				try {
			
					//String targetURL = splitted_line[0];
					String sourceURL = splitted_line[1];
					String sourceDomain = getDomain(sourceURL);
					Integer links_count = counting_map.get(sourceDomain);
					int SOURCE_TRUSTFLOW=Integer.valueOf(splitted_line[13]);
					int COMPUTED_TRUST_RATE_LINK=links_count * SOURCE_TRUSTFLOW;
					// INSERT INTO TRUST_RATING(SOURCE_URL, SOURCE_DOMAIN, NB_LINKS, LINK_TRUSTFLOW, COMPUTED_TRUST_RATE_LINK, COMPUTED_TRUST_RATE_DOMAIN) VALUES (?,?,?,?,?,?)
					pst.setString(1,sourceURL);
					pst.setString(2,sourceDomain);
					pst.setInt(3, links_count);
					pst.setInt(4, SOURCE_TRUSTFLOW);
					pst.setInt(5, COMPUTED_TRUST_RATE_LINK);
					pst.addBatch();
					if (nb_batch == batch_size){
						pst.executeBatch();
						con.commit();
						con.setAutoCommit(false);
						nb_batch=0;
					}
				} catch (Exception exx) {
					exx.printStackTrace();
				}
				nb_line++;
			}

			
			
			// We loop over the file a second time to make the computation 
			
		} catch (Exception ex) {
			ex.printStackTrace();
		}finally{

			if (br != null) {
				try {
					br.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}
		
		
		
	}

	private static void populateLinksMap(String targetURL, String sourceURL){
		//		System.out.println("Target URL : "+targetURL);
		String target_domain=getDomain(targetURL);
		//		System.out.println("Target domain : "+target_domain);
		//		System.out.println("Source URL : "+sourceURL);
		String source_domain=getDomain(sourceURL);
		//		System.out.println("Source domain : "+source_domain);

		if (!"www.cdiscount.com".equals(target_domain)){
			System.out.println("Target domain unknown : "+target_domain);
			//	System.exit(0);
		}	
		Integer local_count = counting_map.get(source_domain);
		if (local_count == null){
			local_count = new Integer(1);
			counting_map.put(source_domain, local_count);
		} else {
			local_count=local_count+1;
			counting_map.put(source_domain,local_count);
		}
	}

	private static void displayFoundLinks(){
		System.out.println("Displaying domain links count");
		Iterator it = counting_map.entrySet().iterator();
		while (it.hasNext()) {
			Map.Entry pairs = (Map.Entry)it.next();
			String domain_name=(String)pairs.getKey();
			Integer count = (Integer)pairs.getValue();
			System.out.println(domain_name+" : "+count);
		}	
	}

	private static String getDomain(String url){
		String target_domain = null;
		if (url.length()>=1 &&url.charAt(url.length()-1)=='\"')
		{
			url = url.replace(url.substring(url.length()-1), "");
		}
		if (url.length()>=1 &&url.charAt(0)=='\"')
		{
			url = url.substring(1);
		}
		url=url.replaceAll("http://","@");
		url=url.replaceAll("https://","@");
		// we hereby construct different tables 
		StringTokenizer target_protoc_tokenize = new StringTokenizer(url,"@");
		while (target_protoc_tokenize.hasMoreTokens()){
			String underTargetURL=target_protoc_tokenize.nextToken();
			StringTokenizer target_tokenize = new StringTokenizer(underTargetURL,"/");
			if (target_tokenize.hasMoreTokens()){
				target_domain = target_tokenize.nextToken();	
				if (target_domain.length()>=1 &&target_domain.charAt(target_domain.length()-1)=='\"')
				{
					target_domain = target_domain.replace(target_domain.substring(target_domain.length()-1), "");
				}
				if (target_domain.indexOf("?")>=0){
					target_domain=target_domain.substring(0,target_domain.indexOf("?"));
				}
				if (target_domain.indexOf("#")>=0){
					target_domain=target_domain.substring(0,target_domain.indexOf("#"));
				}
				if (target_domain.indexOf(":")>=0){
					target_domain=target_domain.substring(0,target_domain.indexOf(":"));
				}
				if (target_domain.indexOf("&")>=0){
					target_domain=target_domain.substring(0,target_domain.indexOf("&"));
				}
				target_domain=target_domain.trim();
			}	
		}
		return target_domain;
	}

	public static String removeBadChars(String s) {
		if (s == null) return null;
		StringBuilder sb = new StringBuilder();
		for(int i=0;i<s.length();i++){ 
			if (Character.isHighSurrogate(s.charAt(i)) ) continue;	
			sb.append(s.charAt(i));
		}
		return sb.toString();
	}
}
